# I2C


## 摘要
飞利浦半导体(现在的恩智浦半导体)开发了一个简单的双向2线总线，用于高效的ic间控制，称为inter-IC或I2C-bus。

仅需要两条总线：一条串行数据线(SDA)；一条串行时钟现(SCL)。

串行8位定向，双向数据传输在标准模式下(Standard-mode)速度高达100kbit/s；在快速模式下(Fast-mode)速度高达400kbit/s；在超快速模式下(Fast-mode Plus 简称Fm+)传输速度高达1Mbit/s；在高速模式下(High-speed)传输速度高达3.4Mbit/s；超高速模式下(Ultra Fast-mode)传输速度高达5Mbit/s。

> 注意，超高速模式(Ultra Fast-mode)是一种单向模式，所以速度可以高达 5Mbit/s

> 后续提到的 `I2C`、`I2C总线`、`I2C-bus` 都是一回事

## 介绍
I2C-bus 实际上已经成为一个行业标准，世界上大概有 50 家公司生产了超过 1000 多种不同的 IC 设备中实现使用。

此外，I2C总线还可用于 SMBus(System Management Bus)、PMBus(Power Management Bus)、IPMI(Intelligent Platform Management Interface)、DDC(Display Data Channel)、ATCA(Advanced Telecom Computing Architecture)等多种控制架构。

本文档帮助设备和系统设计师理解 I2C 总线如何工作，并实现一个工作应用程序。描述了各种操作模式。全面介绍了 I2C 总线的数据传输、握手、总线仲裁方案。

> I3C 是MIPI联盟在 2017 年提出的，恩智浦也有过参与和贡献。MIPI I3C提供了与 I2C 的向后兼容性，提高了速度和减少了功耗。

## I2C-bus 特性
在消费电子、电信和工业电子领域，在看似不相关的设计之间往往有许多相似之处。例如，几乎每个系统都包括:
- 有些智能控制，通常是单片机
- 通用电路，如LCD和LED驱动器，远程I/O端口，RAM, EEPROM，实时时钟或A/D和D/A转换器
- 面向应用的电路，如无线电和视频系统的数字调谐和信号处理电路、温度传感器和智能卡

飞利浦半导体公司(现在的NXP半导体公司)开发了一种简单的双向2线总线，用于有效的ic间控制。这种总线被称为Inter-IC或i2c总线。所有i2c总线兼容设备都包含一个片上接口，允许它们通过i2c总线直接相互通信。这种设计理念解决了设计数字控制电路时遇到的许多接口问题。

以下是一些I2C-bus的特性：
- 只需要两条线;串行数据线(SDA)和串行时钟线(SCL)。
- 连接到总线上的每个设备都是可通过唯一地址寻址的，并且简单的控制器/目标关系始终存在;控制器可以作为控制-发送器或控制-接收器。
- 如果两个或多个控制器同时发起数据传输，它是一个真正的多控制器总线，包括碰撞检测和仲裁，以防止数据损坏，
- 串行、8位定向、双向数据传输，在标准模式下最高可达100kbit /s，在快速模式下最高可达400kbit /s，在快速模式下最高可达1mbit /s，在高速模式下最高可达3.4 Mbit/s。
- 串行，8位定向，单向数据传输高达5mbit/s超高速模式
- 片上滤波抑制总线数据线上的峰值，以保持数据完整性。
- 可连接到同一总线上的ic的数量仅受最大总线电容的限制。在某些条件下，可以允许更大的电容。

### I2C-bus 例子
<div align=center><img src='/pic/imx6ull/022-i2c-1.png'/></div>

## I2C-bus 协议

### 标准模式、快速模式、超快速模式、I2C总线协议

两根导线，串行数据(SDA)和串行时钟(SCL)，在连接到总线的设备之间携带信息。每个设备都有一个唯一的地址(无论是微控制器、LCD驱动器、内存还是键盘接口)，根据设备的功能，它可以作为发射器或接收器。液晶显示器驱动器可能只是一个接收器，而存储器可以接收和传输数据。设备在进行数据传输时，除了发射器和接收器外，还可以考虑作为控制器或目标。控制器是在总线上发起数据传输并产生允许数据传输的时钟信号的设备，这时候，任何寻址的设备都被认为是目标。

I2C总线术语定义
|术语|说明|
|:---|:---|
|发射器|发送数据到总线的机器|
|接收器|从总线接收数据的机器|
|控制器|发起传输、产生时钟信号并终止传输的设备|
|目标|控制器寻址的设备|
|多控制器|在不破坏信息的前提下，可以有多个控制器同时尝试控制总线|
|仲裁器|如果多个控制器同时试图控制总线，则只允许一个控制器这样做，且赢得控制权这个消息不能被破坏|
|同步|同步两台或两台以上设备的时钟信号|

i2c总线是一种多控制器总线。这意味着可以将多个能够控制总线的设备连接到总线上。由于控制器通常是微控制器，让我们考虑连接到i2c总线的两个微控制器之间的数据传输的情况
<div align=center><img src='/pic/imx6ull/023-i2c-2.png'/></div>
这个例子突出了在i2c总线上发现的控制器-目标和接收器-发射器的关系。注意，这些关系不是永久的，而是只取决于当时数据传输的方向。数据的传输将按如下方式进行:

1. 假设微控制器A要向微控制器B发送信息:
    - 微控制器A(控制器)，定位微控制器B(目标)
    - 微控制器A(控制器-发送器)，将数据发送给微控制器B(目标-接收器)
    - 微控制器A终止传输
2. 如果微控制器A需要从微控制器B接收信息:
    - 微控制器A(控制器)寻址微控制器B(目标)
    - 微控制器A(控制器-接收器)接收来自微控制器B(目标-发射器)的数据
    - 微控制器A终止传输

在这种情况下，控制器(微控制器A)会产生定时并终止传输。

将多个微控制器连接到i2c总线的可能性意味着多个控制器可以尝试在同一时间发起数据传输。为了避免此类事件可能引起的混乱，已经制定了一套仲裁程序。这个过程依赖于所有I2C接口到I2C总线的有线和连接。

如果两个或两个以上的控制器试图把信息放到总线上，第一个产生一个“1”，而另一个产生一个“0”，则失去仲裁。仲裁期间的时钟信号是一个同步的时钟组合，由控制器使用有线和连接到SCL线。

在i2c总线上产生时钟信号一直是控制器设备的职责;在总线上传输数据时，每个控制器产生自己的时钟信号。来自控制器的总线时钟信号只能在它们被慢速目标设备拉伸或仲裁发生时被另一个控制器拉伸时被改变。

下表总结了i2c总线规范中强制性和可选部分的使用，以及哪些系统配置使用它们。
||单控制器|多控制器|目标|
|:---|:---|:---|:---|
|开始状态|M|M|M|
|停止状态|M|M|M|
|Acknowledge(应答)|M|M|M|
|Synchronization(同步)|n/a|M|n/a|
|Arbitration(仲裁)|n/a|M|n/a|
|Clock stretching(时钟拉伸)|$O^{[2]}$|$O^{[2]}$|$O$|
|7-bit target address(7-bit 目标地址)|M|M|M|
|10-bit target address(10-bit 目标地址)|O|O|O|
|General Call address(一般调用地址)|O|O|O|
|Software Reset(软件复位)|O|O|O|
|START byte|n/a|$O^{[3]}$|n/a|
|Device ID(设备ID)|n/a|n/a|$O$|

<small>M=强制性的; O=可选的; n/a=不适用;<br/>[1]也指充当目标的控制器; <br/>[2]有些目标的一个特征就是时间的延长。如果系统中没有目标可以延长时钟(保持SCL LOW)，控制器不需要被设计来处理这个过程; <br/>[3]“位碰撞”(软件仿真)多控制器系统应该考虑一个START字节</small>

#### SDA 和 SCL 信号
SDA和SCL都是双向线路，通过电流源或上拉电阻连接到正电源电压。当总线空闲，两条线都是高电平。连接到总线上的设备的输出级必须有开路漏极或开路集电极来执行有线和功能。i2c总线的数据传输速率在标准模式下最高可达100kbit /s，在快速模式下最高可达400kbit /s，在快速模式下最高可达1mbit /s，在高速模式下最高可达3.4 Mbit/s。总线电容限制了连接到总线上的接口的数量。

对于单个控制器应用，如果总线上没有设备会拉长时钟，控制器的SCL输出可以是推挽驱动设计。
<div align=center><img src='/pic/imx6ull/024-i2c-3.png'/></div>

#### SDA 和 SCL 逻辑电平
由于可以连接到 I2C 总线的各种不同的技术设备(CMOS、NMOS、双极)，逻辑“0”(LOW)和“1”(HIGH)的电平不是固定的，取决于$V_{DD}$ 的相关电平。输入参考电平设置为 $V_{DD}$ 的 30% 和 70% ; VIL 为 0.3 $V_{DD}$, VIH 为 0.7 $V_{DD}$。一些传统的设备输入级别固定在VIL = 1.5 V和VIH = 3.0 V，但所有的新设备都需要这个 30%/70% 的规格。

#### 数据的有效性
SDA线上的数据必须在时钟的HIGH周期内保持稳定。只有当SCL线路上的时钟信号为LOW时，数据线的HIGH或LOW状态才会改变。每传输一个数据位，都会产生一个时钟脉冲。
<div align=center><img src='/pic/imx6ull/0005-i2c-5.png'/></div>

#### 开始和停止状态
所有事务以START (S)开始，并由STOP (P)终止。当SCL为HIGH时，SDA线上的HIGH到LOW转换定义了一个START条件。当SCL为HIGH时，SDA线上的LOW到HIGH转换定义了一个停止条件。

<div align=center><img src='/pic/imx6ull/0005-i2c-6.png'/></div>
<center>开始与停止信号</center>

START和STOP条件总是由控制器生成。在START条件之后，总线被认为是繁忙的。在停止条件之后的一段时间内，总线被认为是空闲的。

如果生成重复的START (Sr)而不是STOP条件，总线将保持忙碌。在这方面，START (S)和重复的START (Sr)条件在功能上是相同的。因此，在本文档的其余部分中，除非Sr特别相关，否则S符号将作为通用术语来表示START和重复START条件。

通过连接到总线的设备检测START和STOP条件是很容易的，如果它们包含必要的接口硬件。然而，没有这种接口的微控制器必须在每个时钟周期内至少采样两次SDA线，以感知过渡。

#### 字节格式
SDA行上的每个字节必须是8位长。每次传输可传输的字节数不受限制。每个字节后面必须有一个确认位。数据首先用最高位(MSB)传输。如果一个目标不能接收或发送另一个完整的字节数据，直到它已经执行了一些其他的功能，例如服务内部中断，它可以保持时钟线SCL低，迫使控制器进入一个等待状态。当目标准备好接收另一个字节的数据并释放时钟线SCL时，数据传输继续进行。

<div align=center><img src='/pic/imx6ull/0005-i2c-7.png'/></div>
<center>I2C-bus数据传输</center>

#### ACK 和 NACK
确认发生在每个字节之后。该确认位允许 `接收方` 向 `发送方` 发出信号，表示该字节已被成功接收，并且可以发送另一个字节。控制器产生所有的时钟脉冲，包括确认第9个时钟脉冲。

确认信号(`ACK信号`)的定义如下：`发送端`在确认时钟脉冲期间释放SDA线，因此`接收端`可以将SDA线拉低，在该时钟脉冲的高周期内，SDA线保持稳定的LOW。设置和保持时间也必须考虑在内。

当 SDA 在第九个时钟脉冲一直保持高电平，这被定义为 `NACK信号`。然后，控制器可以生成一个STOP条件来中止传输，或者生成一个重复的START条件来启动一个新的传输。

NACK的产生有五个条件:
- 总线上没有带有传输地址的接收器，因此没有设备以应答
- 接收机无法接收或发送，因为它正在执行一些实时功能，还没有准备好开始与控制器通信
- 在传输过程中，接收方获取它不理解的数据或命令
- 在传输过程中，接收方无法接收更多的数据字节
- 接收控制器必须向目标发射机发送传输结束的信号

#### 时钟同步
两个控制器可以在一个空闲总线上同时开始传输，必须有一种方法来决定使用哪个控制器控制总线并完成它的传输

这是通过时钟同步和仲裁完成的。在单控制器系统中，不需要时钟同步和仲裁。

时钟同步是通过I2C接口到SCL线的有线和连接来实现的。这意味着SCL线上的HIGH到LOW过渡会导致相关控制器开始计算它们的LOW周期，并且一旦控制器时钟达到LOW，它就会保持SCL线处于该状态，直到时钟达到HIGH状态。然而，如果另一个时钟仍然在它的LOW周期内，这个时钟的LOW到HIGH的过渡可能不会改变SCL线的状态。因此，SCL线被具有最长LOW周期的控制器保持为LOW。LOW周期较短的控制器在此期间进入HIGH等待状态
<div align=center><img src='/pic/imx6ull/0005-i2c-8.png'/></div>

当所有相关控制器的LOW周期结束时，时钟线被释放并进入HIGH。然后在控制器时钟和SCL线的状态之间没有区别，所有控制器开始计算它们的高周期。第一个完成HIGH周期的控制器将SCL线再次拉低

这样就产生了一个同步的SCL时钟，其LOW周期由时钟LOW周期最长的控制器确定，HIGH周期由时钟HIGH周期最短的控制器确定。

#### 仲裁
仲裁，与同步一样，是指仅在系统中使用多个控制器时才需要的协议的一部分。仲裁程序不涉及目标。只有当总线空闲时，控制器才能启动传输。两个控制器可以在START条件的最小保持时间($t_{HD;STA}$)内生成一个START条件，从而在总线上产生一个有效的START条件。然后需要仲裁来决定哪个控制器将完成它的传输。

仲裁逐点进行。在每一位期间，当SCL为HIGH时，每个控制器检查SDA级别是否与它发送的内容匹配。这个过程可能需要很多位。两个控制器实际上可以毫无错误地完成整个交易，只要传输是相同的。当控制器第一次尝试发送HIGH，但检测到SDA电平为LOW时，控制器知道已经丢失了仲裁，并关闭了SDA输出驱动。另一个控制器继续完成它的事务。

仲裁过程中不会丢失任何信息。丢失仲裁的控制器可以产生时钟脉冲，直到丢失仲裁的字节结束，并且必须在总线空闲时重新启动它的事务。

如果一个控制器也包含一个目标函数，并且它在寻址阶段失去了仲裁，那么获胜的控制器可能正在试图寻址它。因此，丢失的控制器必须立即切换到目标模式。

双控制器仲裁流程如下图示，根据连接到总线上的控制器的数量，可能会涉及更多的问题。当产生DATA1的控制器的内部数据级别与SDA线上的实际级别之间出现差异时，DATA1输出就会被关闭。这不会影响获胜控制器发起的数据传输。
<div align=center><img src='/pic/imx6ull/0005-i2c-9.png'/></div>





## 参考
[I2C 2021年10月份官方文档](https://www.nxp.com.cn/docs/en/user-guide/UM10204.pdf)


